name: syn-to-gitcode

on:
  push:
    branches: [ main ] # 指定只在推送到 main 分支时触发
  workflow_dispatch: # on button click

jobs:
  GitCode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录
          
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.GITCODE_PRIVATE_KEY }}
          
      - name: Add GitCode to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan gitcode.com >> ~/.ssh/known_hosts
          
      - name: Test SSH connection
        run: |
          ssh -T git@gitcode.com
          
      - name: Configure Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR_ID}+${GITHUB_ACTOR}@users.noreply.github.com"
          
      - name: Sync to GitCode
        run: |
          REPOURL="XIU2sTrackersList"
          REPODIR="$PWD"
          TARGET_DIR="$HOME/TARGET"
          
          mkdir -p "$TARGET_DIR"
          cd "$TARGET_DIR"
          
          # 克隆或更新仓库
          if [ -d "$REPOURL" ]; then
            cd "$REPOURL"
            git fetch origin
            git reset --hard origin/main
          else
            git clone git@gitcode.com:bitcomet-post-bar/"$REPOURL".git
            cd "$REPOURL"
          fi
          
          # 使用 rsync 同步文件，保留 .git 目录
          rsync -av --delete --exclude='.git' "$REPODIR/" ./
          
          # 检查是否有更改
          if git diff --quiet --exit-code; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add .
          git commit -m "Auto-sync from GitHub"
          git push